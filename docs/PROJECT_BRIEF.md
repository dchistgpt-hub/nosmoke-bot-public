# NoSmoke-bot — проектный бриф (понятно и по шагам)

## 1) Зачем этот бот
Поддержка Telegram-чата: вежливые авто-ответы, простая модерация, доставка полезных материалов, статистика. Позже — ответы через GPT и хранение данных в MongoDB.

## 2) Что уже работает (проверено на проде)
- Вебхук через Caddy (домен `bot.chatnzt.ru`) — Telegram шлёт POST на `/bot<TOKEN>`, Caddy проксирует на бот.
- Команды: `/start`, `/ping`, `/help`, `/echo`, `/quiet`, `/about`, `/stats`.
- «Тихие часы» (`/quiet HH:MM-HH:MM`) — в них бот молчит на обычные сообщения.
- Логирование **всех** входящих сообщений в `logs/messages.log` + ежедневная ротация `YYYY-MM-DD_messages.log`.
- `/stats` показывает аптайм, today/total, хвост лога.
- HTTP-проверки (через Express): `/health`, `/uptime`, `/version`.
- Секретный заголовок вебхука включён (Caddy пропускает только, если заголовок правильный).
- Антиспам: режем казино/левые ссылки; команды не душим; в строгом режиме фильтруем всё, что не команда.

> Истина сейчас — состояние на сервере `/root/nosmoke-bot` (compose с bot+caddy, `env_file: .env`, том для логов).

## 3) Как это устроено (простая картинка)
Telegram → Caddy (TLS, секрет заголовка) → бот (Telegraf/Express)  
В боте: middleware-цепочка = проверка секрета → антиспам → логирование → команды → тихие часы → ответы.

## 4) Что планируем дальше (минимальный план)
**MUST (следом):**
1. Синхронизация: вытащить с сервера актуальные `bot/index.js`, `docker-compose.yml`, `Caddyfile` в репозиторий (ветка `release/0.3.0`), оформить PR.
2. Документация:
   - `README.md`: установка, `.env` ключи, деплой, health-чек, где смотреть логи, как включать STRICT.
   - `.env.example` (без секретов):  
     `BOT_TOKEN, DOMAIN, PORT, QUIET_DEFAULT, TELEGRAM_SECRET, ANTISPAM_STRICT`
3. CI/CD (GitHub Actions): checkout → rsync на VPS (не трогая `.env`) → `docker compose up -d --build`.  
   Позже добавим линт/тест/BUILD_SHA.
4. Наблюдаемость: внешний пинг `/health` (UptimeRobot).

**SHOULD (следующий шаг):**
- Подключить MongoDB (см. п.5), хранить пользователей/статьи/модерацию/счётчики.
- Команды для админов: `/ban <userId>`, `/warn <userId>` (только ADMIN_IDS).
- `/healthz` JSON с `{status, version, build, uptime_s}`; `/metrics` (prom-client).

**NICE:**
- ESLint/Prettier, unit-тесты утилит, сжатие старых логов.

## 5) База данных и статьи (на чем мы сойдёмся)
- БД: **MongoDB**, коллекции:
  - `users` — `userId, username, firstName, isBanned, createdAt, lastSeen`.
  - `messages` — сырые входящие (для последующей аналитики).
  - `articles` — статьи/посты: `title, url, text|html, tags[], scheduleAt | cron, status(draft|queued|sent)`.
  - `settings` — глобальные настройки, в т.ч. `quietHours`, `strictMode` и т.д.
  - `moderation` — предупреждения/баны: `userId, type, reason, byAdmin, at`.
- Доставка статей:
  - MVP: админ добавляет статью (пока JSON/API/командой), планировщик шлёт в личку/группу N раз в день вне «тихих часов».
  - Логи доставки в `articles` (время, успех/ошибка).
- GPT-ответы:
  - Сначала **явная команда** `/ask <вопрос>`, позже — по триггерам.
  - Модель: OpenAI (env `OPENAI_API_KEY`), «безопасные подсказки» (не отвечать на запрещённое, учитывать `quietHours`).
  - Ограничения: rate-limit на пользователя, длина контента, таймауты.

## 6) Переменные окружения (.env)
- Уже есть: `BOT_TOKEN, DOMAIN, PORT, QUIET_DEFAULT`.
- Добавим:  
  `TELEGRAM_SECRET` — строка, которую должен прислать прокси в заголовке.  
  `ANTISPAM_STRICT` — `true|false`.  
  `OPENAI_API_KEY` — позже.  
  `MONGO_URI, MONGO_DB` — позже.  
  `ADMIN_IDS` — через запятую.
- `.env` хранится **только на сервере**. В репозитории — `.env.example`.

## 7) Репозиторий vs сервер
- **Источник правды кода** должен быть в GitHub. Всё, что «на сервере и работает», вытягиваем в ветку `release/0.3.0` и мёржим.
- CI не трогает `.env` и не перезатирает его.

## 8) Определения «готово»
- `/health`, `/uptime`, `/version` отдают 200 и корректные данные.
- `/stats` работает, логи крутятся ежедневно.
- Вебхук 200 через Caddy (в логах видно POST от Telegram).
- Деплой из GitHub вручную (workflow_dispatch) — ок.
- Документация покрывает быстрый старт и проверку.

## 9) Риски/заметки
- При ошибках 502 смотреть логи Caddy и бота, сверять `getWebhookInfo`.
- Бэкапы логов/БД — потом добавим.
- Перед релизом: ротация бот-токена у BotFather и обновление `.env`.
