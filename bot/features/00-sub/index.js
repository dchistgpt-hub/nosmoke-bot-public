"use strict";

/**
 * Subscription landing (start) feature.
 * Sends the welcome text + single button "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π".
 * All side effects are inside enable(app, bot, db).
 */

module.exports.enable = function enable(app, bot, db) {
  const BASE =
    process.env.PUBLIC_BASE_URL ||
    process.env.PUBLIC_ORIGIN ||
    "https://bot.chatnzt.ru"; // –ø–æ–º–µ–Ω—è–µ—à—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏

  const OFFER_URL = "https://disk.yandex.ru/i/yQ2FfOtBdy_NTw";

  const buildPayUrl = (ctx) => {
    const tgId = (ctx && ctx.from && ctx.from.id) ? String(ctx.from.id) : "";
    // UI "payments" —É–∂–µ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ bot:3000, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /pay –µ—Å—Ç—å.
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É.
    const u = new URL("/pay", BASE);
    u.searchParams.set("kind", "sub");
    u.searchParams.set("term", "30");
    if (tgId) u.searchParams.set("tg_id", tgId);
    return u.toString();
  };

  const welcomeHtml =
`<b>–ü—Ä–∏–≤–µ—Ç! üëã –ú—ã ‚Äî –ê–ª–µ–∫—Å–µ–π –∏ –î–º–∏—Ç—Ä–∏–π, —Å–æ–∑–¥–∞—Ç–µ–ª–∏ AI Chatnzt ‚Äî –ù–∏–∫–æ—Ç–∏–Ω–æ–∑–∞–≤–∏—Å–∏–º–∞—è —Ç–µ—Ä–∞–ø–∏—è.</b>

–ï—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–Ω–∞—á–∏—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∂–µ–ª–∞–Ω–∏–µ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç —Å–∏–≥–∞—Ä–µ—Ç. –ò –º—ã –∑–Ω–∞–µ–º, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —ç—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ª–µ–≥–∫–æ, –±–µ–∑ —Å—Ä—ã–≤–æ–≤ –∏ –º—É–∫.

–ù–∞—à AI ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´—É–º–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫¬ª. –≠—Ç–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å, –Ω–∞—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ —Å–æ—Ç–Ω—è—Ö —Ç—ã—Å—è—á –Ω–∞—É—á–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏–∑–±–∞–≤–∏–ª–∏—Å—å –æ—Ç –∫—É—Ä–µ–Ω–∏—è. –ú—ã —Å–æ–±—Ä–∞–ª–∏ –æ–ø—ã—Ç –ª—É—á—à–∏—Ö –º–µ—Ç–æ–¥–∏–∫, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ –∂–∏–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –ø–æ–±–µ–¥ –Ω–∞–¥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é, —á—Ç–æ–±—ã —Ç–≤–æ–π –ø—É—Ç—å –±—ã–ª –ª–µ–≥—á–µ –∏ –∫–æ—Ä–æ—á–µ.

–û–Ω–∞ –∏–∑—É—á–∞–µ—Ç —Ç–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ —Ç—ã –æ—Å–æ–±–µ–Ω–Ω–æ —É—è–∑–≤–∏–º –ø–µ—Ä–µ–¥ —Å–∏–≥–∞—Ä–µ—Ç–æ–π, –∏ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–∏ –º–∏–Ω—É—Ç—ã –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ä–≤–∞—Ç—å—Å—è.

üî• –¢—ã –±–æ–ª—å—à–µ –Ω–µ –æ–¥–∏–Ω –Ω–∞ —ç—Ç–æ–π –≤–æ–π–Ω–µ. –ú—ã –±—É–¥–µ–º —Ä—è–¥–æ–º 24/7 ‚Äî –≤ —Ç–≤–æ—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –≤ –∫–∞–∂–¥–æ–º –º–æ–º–µ–Ω—Ç–µ, –∫–æ–≥–¥–∞ —Ä—É–∫–∞ —Ç—è–Ω–µ—Ç—Å—è –∑–∞ –ø–∞—á–∫–æ–π.

üí≥ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å –∫—É—Ä—Å–∞:</b> 790 —Ä—É–±.
‚è≥ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> 30 –¥–Ω–µ–π.

–ï—Å–ª–∏ —Ç—ã –≥–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –∂–º–∏ ¬´–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.

–ü—Ä–æ–¥–æ–ª–∂–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="${OFFER_URL}">—É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã</a>.

–ú–æ–∏ –∫–æ–º–∞–Ω–¥—ã: /ping, /echo, /quiet, /stats, /health, /uptime, /version, /about`;

  // –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start ‚Äî —Å—Ç–∞–≤–∏–º —Ä–∞–Ω–æ –∏ –Ω–µ –∑–æ–≤—ë–º next(), —á—Ç–æ–±—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  bot.start(async (ctx) => {
    try {
      const keyboard = {
        inline_keyboard: [[
          { text: "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π", url: buildPayUrl(ctx) }
        ]]
      };
      await ctx.reply(welcomeHtml, {
        parse_mode: "HTML",
        disable_web_page_preview: true,
        reply_markup: keyboard
      });
      return; // –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º next() ‚Üí –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ /start-—Ö–µ–Ω–¥–ª–µ—Ä—ã –Ω–µ –∏—Å–ø–æ–ª–Ω—è—Ç—Å—è
    } catch (e) {
      console.error("sub.start error:", e && e.message || e);
    }
  });

  console.log('Feature "sub" enabled');
};
